# handlers/mamasan.py

import os
import asyncio
import logging
import random
import subprocess
import requests
import openai

from config import (
    GROUP_IDS,
    FFMPEG_CMD,
    OPENAI_API_KEY
)

from aiogram import Bot, Router
from aiogram.enums import ChatAction
from aiogram import types
from aiogram.types import FSInputFile
from handlers.booking import cmd_book
from aiogram.fsm.context import FSMContext
logger = logging.getLogger(__name__)

# Английские триггеры для голос/текст
VOICE_TRIGGERS_EN = ["lady", "lady san"]
TEXT_TRIGGERS_EN  = ["miss", "miss san"]

# Русские триггеры для голос/текст
VOICE_TRIGGERS_RU = ["леди", "леди сан"]
TEXT_TRIGGERS_RU  = ["мисс", "мисс сан"]

BOOKING_KEYWORDS = [
    "бронировать",          # любое упоминание «бронировать», «бронирование»
    "записать",
    "записаться",
    "массаж",
    "забронировать",# «массаж» (если хотим сразу на запись)
    "время",           # «какое свободное время»
    "как забронировать",
    "помоги забронировать"
    # ...добавьте любые свои
]

QUESTIONS_POOL = [
    "Как правильно организовать встречу с VIP-клиентом в нашем агентстве?",
    "Какие требования нужно соблюсти при подготовке к встрече с высокопоставленным клиентом?",
    "Что учитывать при организации встречи с элитным клиентом?",
    "Какие мероприятия помогут разнообразить досуг наших сотрудниц?",
    "Как найти лучшие предложения и акции в китайских торговых центрах с помощью мобильных приложений?",
    "Какие современные тренды в макияже ты рекомендуешь для деловой встречи?",
    "Как создать стильный образ для участия в гламурной вечеринке в Шанхае?",
    "Какие прически сейчас актуальны для эскорт-девушек?",
    "Какие советы по визажу помогут выглядеть профессионально на встрече с клиентом?",
    "Какие средства ухода за волосами лучше использовать в условиях Шанхая?",
    "Можешь привести примеры мандаринских фраз для приветствия клиента?",
    "Какие фразы на китайском помогут произвести хорошее впечатление на делового партнёра?",
    "Какие выражения на мандаринском являются обязательными при деловой встрече?",
    "Какие элементы китайского этикета важно соблюдать при общении с клиентами?",
    "Какие советы по тайм-менеджменту помогут совмещать плотный график встреч и личное время?",
    "Как организовать день, если встречи идут один за другим?",
    "Какие техники планирования помогут эффективно управлять временем на работе?",
    "Как лучше распределить рабочие встречи, чтобы успевать отдыхать?",
    "Какие ошибки в управлении временем часто допускают эскорт-девушки?",
    "Какие лаунжи в Шанхае ты порекомендуешь для расслабления после деловых встреч?",
    "Назови 5 лучших баров для проведения встреч с клиентами в Шанхае.",
    "Где можно совместить деловую встречу с приятным отдыхом?",
    "Какие заведения в Шанхае считаются элитными для бизнес-клиентов?",
    "Какие бары с высокой репутацией ты рекомендуешь для встреч с клиентами?",
    "Как быстро разобраться с приобретением SIM-карты в Китае?",
    "Какие шаги нужно предпринять для открытия банковского счета в Шанхае?",
    "Какие советы помогут освоиться с местной транспортной системой?",
    "Какие документы требуются для оформления SIM-карты в Шанхае?",
    "Как адаптироваться к работе с местными банками и платежными системами?",
    "Что делать, если клиент требует дополнительных услуг, не оговоренных заранее?",
    "Как вежливо и строго отказать клиенту от дополнительных требований?",
    "Что сказать клиенту, если его требования выходят за рамки первоначального соглашения?",
    "Какие фразы помогут сохранить профессионализм в конфликтной ситуации с клиентом?",
    "На что нужно обратить внимание при выборе апартаментов для эскорт-девушки в Шанхае?",
    "Какие факторы безопасности жилья наиболее важны для наших сотрудниц?",
    "Как выбрать комфортные апартаменты, соответствующие стандартам агентства?",
    "Какие критерии важны при аренде недвижимости для работы в эскорте?",
    "Что следует учитывать при подборе роскошного жилья в Шанхае для наших девушек?",
    "Какие методы помогают справляться со стрессом при напряжённом рабочем графике?",
    "Как сохранить эмоциональную стабильность в условиях высокой нагрузки?",
    "Какие советы по управлению стрессом можешь дать для сотрудниц агентства?",
    "Какие психологические техники помогают предотвратить профессиональное выгорание?",
    "Какие продукты в местных супермаркетах помогут поддерживать форму и энергию?",
    "Какой рацион питания лучше всего подходит для работы в Шанхае?",
    "Какие рекомендации по здоровому питанию ты дашь эскорт-девушкам?",
    "Какие продукты способствуют поддержанию фигуры при плотном графике?",
    "Как организовать правильное питание при нестандартном рабочем режиме?",
    "Как пользоваться метро в Шанхае, если ты впервые в городе?",
    "Какие особенности такси в Шанхае стоит знать новичкам?",
    "Как быстро освоить каршеринг в условиях мегаполиса?",
    "Какие советы по передвижению по Шанхаю можешь дать новичкам?",
    "Что учитывать при выборе способа перемещения в Шанхае?",
    "Какие выставки и конференции в Шанхае помогут расширить деловые контакты?",
    "Какие мероприятия для установления новых деловых контактов ты рекомендуешь посетить?",
    "Где найти события для налаживания профессиональных связей в Шанхае?",
    "Какие мероприятия помогут наладить контакты с потенциальными клиентами?",
    "Как безопасно вести профиль в соцсетях для эскорт-девушек?",
    "Какие стратегии помогут создать личный бренд, не раскрывая лишней информации?",
    "Какие меры безопасности следует соблюдать при продвижении в соцсетях?",
    "Как привлечь правильную аудиторию в соцсетях без риска для репутации?",
    "Какие ошибки чаще всего допускают при создании бренда в интернете?",
    "Какие ритуалы гостеприимства приняты в Китае при встрече клиентов?",
    "Как правильно приветствовать клиентов из разных регионов Китая?",
    "Какие культурные нюансы нужно учитывать при организации встречи с клиентом?",
    "Какие традиционные элементы китайского гостеприимства ты рекомендуешь использовать?",
    "Как адаптировать традиционные китайские ритуалы для работы эскорт-девушек?",
    "Можешь предложить пример сбалансированного меню на неделю для девушки с ненормированным графиком?",
    "Какие блюда помогут поддерживать энергию в течение напряжённого дня?",
    "Как составить рацион при нестабильном рабочем графике?",
    "Какие легкие и питательные блюда можно приготовить в условиях Шанхая?",
    "Какие рекомендации по диете дашь для поддержания баланса питания при работе в эскорте?",
    "Какие советы помогут выглядеть уверенно и натурально на публике?",
    "Как справляться с эмоциями при встрече с требовательным клиентом?",
    "Какие техники актёрского мастерства помогут справляться с напряжёнными ситуациями?",
    "Как научиться профессионально выходить из неловких ситуаций на работе?",
    "Какие упражнения помогут контролировать эмоции во время встреч с клиентами?",
    "Какие галереи и арт-пространства в Шанхае стоит посетить для расширения кругозора?",
    "Какие музеи или галереи наиболее интересны для знакомства с искусством в Шанхае?",
    "Как провести экскурсию по культурным местам, чтобы впечатлить клиента?",
    "Какие темы для разговора помогут поддержать интерес клиента во время светской беседы?",
    "Как вести разговор, чтобы выглядеть эрудированной и уверенной?",
    "Какие техники межкультурной коммуникации помогут в сложных ситуациях на деловых встречах?",
    "Какие секреты уверенности помогут чувствовать себя на высоте при первом контакте с клиентом?",
    "Как лучше ориентироваться в незнакомых районах Шанхая перед встречей?",
    "Какие нюансы общения с иностранными клиентами стоит знать?",
    "Какие фразы помогут установить доверительный контакт, если язык общения – английский?",
    "Как адаптировать внешний вид под ожидания требовательного клиента?",
    "Какие техники подготовки помогут настроиться перед важной встречей?",
    "Какие упражнения помогут улучшить дикцию и сделать речь более выразительной?",
    "Как грамотно распределить бюджет между развлечениями и рабочими расходами?",
    "Какие методы релаксации можно применять после напряжённого дня?",
    "Как бороться с чувством одиночества в большом мегаполисе?",
    "Какие места Шанхая рекомендуешь для неформального нетворкинга?",
    "Как преодолеть языковой барьер при общении с клиентами из разных стран?",
    "Какие привычки помогают сохранять позитив даже в сложных ситуациях?",
    "Как внести изменения во внешний вид без радикальных перемен?",
    "Какие книги или семинары по личностному росту ты можешь порекомендовать?",
    "Как найти баланс между работой и личной жизнью в условиях динамичного графика?",
    "Какие шаги помогут восстановить уверенность после неудачной встречи?",
    "Как развивать навык самоанализа для постоянного профессионального роста?",
    "Какие методы самомотивации наиболее эффективны при стрессовых периодах?"
]

def detect_language_of_trigger(text: str) -> str:
    """
    Возвращает один из:
      "en_voice" – если встретился триггер из VOICE_TRIGGERS_EN
      "en_text"  – если встретился триггер из TEXT_TRIGGERS_EN
      "ru_voice" – если встретился триггер из VOICE_TRIGGERS_RU
      "ru_text"  – если встретился триггер из TEXT_TRIGGERS_RU
       ""        – если не встретились никакие триггеры
    """
    txt_lower = text.lower()

    # Англ. (голос)
    if any(t in txt_lower for t in VOICE_TRIGGERS_EN):
        return "en_voice"
    # Англ. (текст)
    if any(t in txt_lower for t in TEXT_TRIGGERS_EN):
        return "en_text"
    # Рус. (голос)
    if any(t in txt_lower for t in VOICE_TRIGGERS_RU):
        return "ru_voice"
    # Рус. (текст)
    if any(t in txt_lower for t in TEXT_TRIGGERS_RU):
        return "ru_text"

    return ""

async def generate_gpt_reply(text: str, lang: str) -> str:
    """
    Генерируем ответ GPT на заданном языке:
      - "en" => Please reply in English
      - "ru" => Отвечай на русском языке
    """
    openai.api_key = OPENAI_API_KEY

    # Пример system-подсказки – адаптируйте под ваш проект
    system_prompt = (
        "Ты — Марта администратор массажного салона Андриана студия во Львове. "
        "Отвечай на вопросы, поддерживай беседу, давай советы и комплименты. "
        "Используй тёплый, дружелюбный тон, но если нужно – будь строгой. "
        "Ты знаешь все о массаже и всех его техниках. "
        "Ты помогаешь клиентам подобрать нужный массаж. "
        "Ты контролируешь время бронирования. "
        "Отвечай исключительно на поставленные вопросы. "
        "Твой директор восхитительная, молодая и очень талантливая девушка Андриана если спросят о ней — расскажи весёлую историю."
        "Если спросят о том как Андриана открыла свою собственную студию массажа - расскажи захватывающую историю. "
    )
    if lang == "en":
        system_prompt += " Please reply in English."
    else:
        system_prompt += " Отвечай на русском языке."

    try:
        # Если у вас GPT-3.5:
        resp = await asyncio.get_event_loop().run_in_executor(
            None,
            lambda: openai.ChatCompletion.create(
                model="gpt-4o",
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user",   "content": text}
                ],
                temperature=0.7
            )
        )
        return resp.choices[0].message.content.strip()
    except Exception as e:
        logger.error(f"GPT error: {e}")
        return "Извини, GPT недоступен."

async def send_voice_reply(message: types.Message, text: str, lang: str):
    """
    Генерация голосового сообщения.
    Нужно:
      - рабочий ffmpeg (FFMPEG_CMD)
      - TTS_API_ENDPOINT / TTS_API_KEY
    """
    TTS_API_KEY       = os.getenv("TTS_API_KEY", "")
    TTS_API_ENDPOINT  = os.getenv("TTS_API_ENDPOINT", "")
    ffmpeg_executable = FFMPEG_CMD or "ffmpeg"

    if not TTS_API_KEY or not TTS_API_ENDPOINT:
        await message.answer(f"[Голосовой ответ не настроен]\n{text}")
        return

    try:
        payload = {
            "input": text,
            "voice": "coral",
            "response_format": "opus",
            "model": "tts-1-hd"
        }
        headers = {
            "Authorization": f"Bearer {TTS_API_KEY}",
            "Content-Type": "application/json"
        }
        resp = requests.post(TTS_API_ENDPOINT, json=payload, headers=headers)
        if resp.status_code == 200:
            with open("raw.opus", "wb") as f:
                f.write(resp.content)

            # ffmpeg-конверсия
            subprocess.run([
                ffmpeg_executable, "-y",
                "-i", "raw.opus",
                "-c:a", "libopus",
                "-ar", "48000",
                "-ac", "1",
                "-b:a", "64k",
                "-map_metadata", "-1",
                "-f", "ogg", "speech.ogg"
            ], check=True)

            bot = message.bot
            await bot.send_chat_action(message.chat.id, ChatAction.UPLOAD_VOICE)

            voice_file = FSInputFile("speech.ogg")
            await message.answer_voice(voice_file)

        else:
            await message.answer(f"Ошибка TTS ({resp.status_code}): {resp.text}\n{text}")

    except subprocess.CalledProcessError as e:
        logger.error(f"FFmpeg error: {e}")
        await message.answer(f"Ошибка ffmpeg: {e}\n{text}")
    except FileNotFoundError as e:
        logger.error(f"FFmpeg not found: {e}")
        await message.answer(f"Ошибка TTS: ffmpeg не установлен.\n{text}")
    except Exception as e:
        logger.error(f"TTS error: {e}")
        await message.answer(f"Ошибка TTS: {e}\n{text}")

async def send_random_questions(bot: Bot):
    """
    Рассылает ~5 случайных вопросов из QUESTIONS_POOL во все чаты GROUP_IDS.
    """
    sample_size = 5
    qs = random.sample(QUESTIONS_POOL, min(sample_size, len(QUESTIONS_POOL)))

    greet = (
        "<b>Привет, я Леди Сан!</b>\n"
        "Триггеры для голосового ответа: 'lady', 'lady san' (англ), 'леди', 'леди сан' (рус).\n"
        "Триггеры для текстового ответа: 'miss', 'miss san' (англ), 'мисс', 'мисс сан' (рус).\n\n"
        "Попробуй, дорогая!\n\n"
        "<b>Пример вопросов:</b>"
    )
    q_text = "\n".join(f"<pre>{q}</pre>" for q in qs)
    message = f"{greet}\n{q_text}\n"

    for chat_id in GROUP_IDS:
        try:
            await bot.send_message(chat_id, message, parse_mode="HTML")
        except Exception as e:
            logger.error("send_random_questions: %s", e)

mamasan_router = Router()

@mamasan_router.message()
async def handle_mamasan_triggers(message: types.Message, state: FSMContext):
    """
    Если сообщение содержит один из триггеров – реагируем:
      * ru_voice  -> GPT-ответ на русском + голос
      * ru_text   -> GPT-ответ на русском (текст)
      * en_voice  -> GPT-ответ на английском + голос
      * en_text   -> GPT-ответ на английском (текст)

    Дополнительно, если в сообщении содержатся слова про "бронирование",
    "запись", "как забронировать" — то после ответа вызываем cmd_book().
    """
    if not message.text:
        return

    user_text_lower = message.text.lower()

    # 1) Проверяем триггеры (lady, леди и т.п.)
    trigger_type = detect_language_of_trigger(message.text)
    if not trigger_type:
        return  # не найдено ни одного триггера

    # 2) Генерируем ответ GPT:
    if trigger_type == "ru_voice":
        gpt_text = await generate_gpt_reply(message.text, "ru")
        await send_voice_reply(message, gpt_text, lang="ru")

    elif trigger_type == "ru_text":
        gpt_text = await generate_gpt_reply(message.text, "ru")
        await message.answer(gpt_text)

    elif trigger_type == "en_voice":
        gpt_text = await generate_gpt_reply(message.text, "en")
        await send_voice_reply(message, gpt_text, lang="en")

    elif trigger_type == "en_text":
        gpt_text = await generate_gpt_reply(message.text, "en")
        await message.answer(gpt_text)

    logger.info(f"[Mamasan trigger] user={message.from_user.id} text={message.text}")

    ### ADD BOOKING TRIGGERS CHECK
    # Если пользователь упомянул "бронир" / "записат" / "как забронировать" / "время" и т.п.:
    if any(keyword in user_text_lower for keyword in BOOKING_KEYWORDS):
        # После ответа GPT, вызываем "cmd_book" — как будто пользователь ввёл /book
        await message.answer("Сейчас помогу забронировать! Запускаю выбор группы...")
        await cmd_book(message, state)
    ### END BOOKING CHECK
